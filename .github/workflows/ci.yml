name: Reusable CI

on:
  workflow_call:
    inputs:
      project_path:
        required: false
        type: string
        default: "."
      stack:
        required: false
        type: string
        default: ""     # node | php | dotnet | python | go | empty for auto-detect
      skip_tests:
        required: false
        type: boolean
        default: false

jobs:
  ci: 
    name: Detecta Stack e Executa Testes
    runs-on: ubuntu-latest
    env:
      REUSABLE_PATH: .__reusable_actions__

    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4

      - name: Checkout reusable-actions scripts
        uses: actions/checkout@v4
        with:
          repository: heliomarpm/reusable-actions
          ref: main
          path: ${{ env.REUSABLE_PATH }}


      - name: Files in workspace
        run: |
          echo "üìÇ Current directory:"
          pwd
          echo "üìÑ Files in root:"
          ls -la


      - name: üîç Resolve project stack
        id: stack
        working-directory: ${{ inputs.project_path }}
        run: |
          if [[ -n "${{ inputs.stack }}" ]]; then
            echo "Using stack from input: ${{ inputs.stack }}"
            echo "value=${{ inputs.stack }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          chmod +x $REUSABLE_PATH/scripts/detect-stack.sh
          STACK=$($REUSABLE_PATH/scripts/detect-stack.sh)

          if [[ -z "$STACK" ]]; then
            echo "value=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ Detected stack: $STACK"
          echo "value=$STACK" >> $GITHUB_OUTPUT


      - name: Evaluate test execution
        id: tests
        working-directory: ${{ inputs.project_path }}
        run: |
          if [[ "${{ inputs.skip_tests }}" == "true" ]]; then
            echo "Tests skipped by input."
            echo "run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ ! -d "tests" && ! -d "__tests__" && ! -d "test" ]]; then
            echo "No test directories found."
            echo "run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Tests will run."
          echo "run=true" >> $GITHUB_OUTPUT
  

      - name: Run unit tests
        if: steps.stack.outputs.value != '' && steps.tests.outputs.run == 'true'
        working-directory: ${{ inputs.project_path }}
        run: |
          chmod +x $REUSABLE_PATH/scripts/test-${{ steps.stack.outputs.value }}.sh
          $REUSABLE_PATH/scripts/test-${{ steps.stack.outputs.value }}.sh


      - name: Run coverage tests
        if: steps.stack.outputs.value != '' && steps.tests.outputs.run == 'true'
        working-directory: ${{ inputs.project_path }}
        continue-on-error: true
        run: |
          chmod +x $REUSABLE_PATH/scripts/test-coverage-${{ steps.stack.outputs.value }}.sh
          $REUSABLE_PATH/scripts/test-coverage-${{ steps.stack.outputs.value }}.sh

      - name: üì¶ Upload coverage artifact
        if: steps.stack.outputs.value != '' && steps.tests.outputs.run == 'true' && hashFiles('coverage/coverage-summary.normalized.json') != ''
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: coverage-report
          path: coverage/coverage-summary.normalized.json

      - name: Fail if stack not detected
        if: steps.stack.outputs.value == ''
        run: |
          echo "‚ùå Stack not detected. Check project_path or repository structure."