name: Reusable CI

on:
  workflow_call:
    inputs:
      project_path:
        required: false
        type: string
        default: "."
      stack:
        description: 'Stack the project. (node | php | dotnet | python | go | empty for auto-detect)'
        required: false
        type: string
        default: null     # node | php | dotnet | python | go | empty for auto-detect
      skip_tests:
        required: false
        type: boolean
        default: false
      # package_manager:
      #   description: 'Package manager to install dependencies (npm, yarn, pnpm). (PadrÃ£o: npm)'
      #   required: false
      #   default: 'npm'
      #   type: string
      test_coverage_command:
        description: 'Command to run coverage tests.'
        required: false
        # default: 'npm test -- --no-watch --coverage --reporter=verbose'
        type: string
      test_continue_on_failure:
        description: 'Continue pipeline even if tests fail. (default: true)'
        required: false
        type: boolean
        default: true

jobs:
  ci: 
    name: resolve stack e executa testes
    runs-on: ubuntu-latest
    env:
      REUSABLE_PATH: __reusable_actions__

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.project_path }}

    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4

      - name: Checkout reusable-actions scripts
        uses: actions/checkout@v4
        with:
          repository: heliomarpm/reusable-actions
          ref: main
          path: ${{ env.REUSABLE_PATH }}

      - name: Files in workspace
        run: |
          echo "ðŸ“‚ Current directory:"
          pwd
          echo "ðŸ“„ Files in root:"
          ls -la

      - name: ðŸ” Resolve project stack
        id: stack
        # working-directory: ${{ inputs.project_path }}
        run: |
          if [[ -n "${{ inputs.stack }}" ]]; then
            echo "â†’ Using stack from input: ${{ inputs.stack }}"
            echo "value=${{ inputs.stack }}" >> $GITHUB_OUTPUT
            echo "source=input" >> $GITHUB_OUTPUT
            exit 0
          fi
            
          chmod +x $REUSABLE_PATH/scripts/shared/detect-stack.sh
          STACK=$($REUSABLE_PATH/scripts/shared/detect-stack.sh)
          
          if [[ -z "$STACK" ]]; then
            echo "value=" >> $GITHUB_OUTPUT
            echo "source=not-detected" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… Detected stack: $STACK"
          echo "value=$STACK" >> $GITHUB_OUTPUT
          echo "source=detected" >> $GITHUB_OUTPUT

      - name: Fail if stack not detected
        if: steps.stack.outputs.value == ''
        run: |
          echo "âŒ Stack not detected. Check project_path or repository structure."
          exit 1

      - name: ðŸ§ª Evaluate test execution
        id: tests
        # working-directory: ${{ inputs.project_path }}
        run: |
          if [[ "${{ inputs.skip_tests }}" == "true" ]]; then
            echo "â†’ Tests skipped by input."
            echo "run=false" >> $GITHUB_OUTPUT
            echo "reason=skip_tests input" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ ! -d "tests" && ! -d "__tests__" && ! -d "test" ]]; then
            echo "â†’ No test directories found."
            echo "run=false" >> $GITHUB_OUTPUT
            echo "reason=no test folders detected" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… Tests will run."          
          echo "run=true" >> $GITHUB_OUTPUT
          echo "reason=tests detected" >> $GITHUB_OUTPUT
  
      - name: â–¶ï¸ Run unit tests
        if: steps.stack.outputs.value != '' && steps.tests.outputs.run == 'true'
        working-directory: ${{ inputs.project_path }}
        run: |
          STACK="${{ steps.stack.outputs.value }}"
          SCRIPT="$REUSABLE_PATH/scripts/plugins/$STACK/test.sh"
          chmod +x "$SCRIPT"
          "$SCRIPT"

      - name: ðŸ“Š Run coverage tests
        id: coverage
        if: steps.stack.outputs.value != '' && steps.tests.outputs.run == 'true'
        working-directory: ${{ inputs.project_path }}
        continue-on-error: ${{ inputs.test_continue_on_failure }}
        run: |
          STACK="${{ steps.stack.outputs.value }}"
          SCRIPT="$REUSABLE_PATH/scripts/plugins/$STACK/coverage.sh"
          chmod +x "$SCRIPT"
          "$SCRIPT"

          if "$SCRIPT"; then
            echo "status=executed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

          if [[ -f coverage/coverage-summary.normalized.json ]]; then
            PCT=$(jq -r '.total.lines.pct // empty' coverage/coverage-summary.normalized.json)
            if [[ -n "$PCT" ]]; then
              echo "pct=$PCT" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ðŸ“¦ Upload coverage artifact
        if: hashFiles('coverage/coverage-summary.normalized.json') != ''
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: coverage-report
          path: coverage/coverage-summary.normalized.json

      - name: ðŸ“ CI Summary
        if: always()
        run: |
          {
            echo "## ðŸ§ª CI Summary"
            echo ""
            echo "**ðŸ“‚ Project path:** \`${{ inputs.project_path }}\`"
            echo ""

            if [[ "${{ steps.stack.outputs.value }}" != "" ]]; then
              echo "**ðŸ§± Stack:** \`${{ steps.stack.outputs.value }}\` (_${{ steps.stack.outputs.source }}_)"
            else
              echo "**ðŸ§± Stack:** âŒ not detected"
            fi

            echo ""
            if [[ "${{ steps.tests.outputs.run }}" == "true" ]]; then
              echo "**ðŸ§ª Tests:** executed"
            else
              echo "**ðŸ§ª Tests:** skipped (_${{ steps.tests.outputs.reason }}_)"
            fi

            echo ""
            if [[ "${{ steps.coverage.outputs.status }}" == "executed" ]]; then
              if [[ -n "${{ steps.coverage.outputs.pct }}" ]]; then
                echo "**ðŸ“Š Coverage:** ${{ steps.coverage.outputs.pct }}%"
              else
                echo "**ðŸ“Š Coverage:** executed (no summary produced)"
              fi
            elif [[ "${{ steps.coverage.outputs.status }}" == "failed" ]]; then
              echo "**ðŸ“Š Coverage:** failed"
            else
              echo "**ðŸ“Š Coverage:** not executed"
            fi

            echo ""
            if [[ -f coverage/coverage-summary.normalized.json ]]; then
              echo "**ðŸ“¦ Artifacts:** coverage-report"
            fi
          } >> $GITHUB_STEP_SUMMARY
