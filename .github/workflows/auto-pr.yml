name: Reusable Create/Update PR

on:
  workflow_call:
    inputs:
      # base_branch:
      #   description: "Branch de destino do PR (e.g., main)."
      #   required: false
      #   default: "main"
      #   type: string

      # head_branch:
      #   description: "Branch de origem do PR (e.g., develop)."
      #   required: false
      #   default: "develop"
      #   type: string

      skip-tests:
        type: boolean
        required: false
        default: false

      min-coverage:
        type: number
        required: false
        default: 80

      coverage-mode:
        type: string
        required: false
        default: "info"    # info | block

      # coverage-command:
      #   type: string
      #   required: false
      #   default: ""

      # coverage-file:
      #   type: string
      #   required: false
      #   default: "coverage/coverage-summary.json"

    secrets:
      GH_TOKEN:
        required: true

jobs:
  check-branch:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.branch.outputs.skip }}
      head: ${{ steps.branch.outputs.head }}
      base: ${{ steps.branch.outputs.base }}

    # permissions:
    #   contents: read
    #   pull-requests: write

    steps:
      - name: üìå Resolve PR base branch
        id: branch
        run: |
          HEAD="${{ github.event.workflow_run.head_branch }}"
          echo "Detected head branch: $HEAD"

          if [ "$HEAD" = "main" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          elif [ "$HEAD" = "develop" ]; then
            echo "base=main" >> $GITHUB_OUTPUT
          else
            echo "base=develop" >> $GITHUB_OUTPUT
          fi

          echo "head=$HEAD" >> $GITHUB_OUTPUT

      - name: üö´ Skip main branch
        if: steps.branch.outputs.skip == 'true'
        run: echo "Main branch detected. Skipping auto PR."

  run-coverage:
    needs: check-branch
    if: needs.check-branch.outputs.skip != 'true' && inputs.skip-tests != true 
    runs-on: ubuntu-latest
    outputs:
      line: ${{ steps.coverage.outputs.line }}
      status: ${{ steps.coverage-check.outputs.status }}

    steps:
      - name: üì• Download coverage artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-report
          path: coverage

      - name: üìä Read coverage report
        id: coverage
        run: |
          FILE="coverage/coverage-summary.normalized.json"

          if [ ! -f "$FILE" ]; then
            echo "‚ö†Ô∏è Coverage artifact not found"
            echo "line=" >> $GITHUB_OUTPUT
            echo "status=missing" >> $GITHUB_OUTPUT
            exit 0
          fi

          LINE=$(jq '.line' "$FILE")
          echo "line=$LINE" >> $GITHUB_OUTPUT
          echo "status=found" >> $GITHUB_OUTPUT
       

      - name: ‚úÖ Evaluate coverage
        id: coverage-check
        run: |
          FOUND_STATUS="${{ steps.coverage.outputs.status }}"
          LINE=${{ steps.coverage.outputs.line }}
          MIN=${{ inputs.min-coverage }}
          MODE="${{ inputs.coverage-mode }}"

          FINAL_STATUS="passed"

          if [ "$FOUND_STATUS" = "missing" ]; then
            FINAL_STATUS="missing"
            echo "‚ö†Ô∏è No tests or coverage detected"

            if [ "$MODE" = "block" ]; then
              echo "‚ùå Blocking PR: tests not implemented"
              exit 1
            fi
          elif  (( $(echo "$LINE < $MIN" | bc -l) )); then
            FINAL_STATUS="failed"
            echo "‚ùå Coverage below threshold ($LINE < $MIN)"

            if [ "$MODE" = "block" ]; then
              exit 1
            fi
          fi

          echo "status=$FINAL_STATUS" >> $GITHUB_OUTPUT


  create-pr:
    needs:
      - check-branch
      - run-coverage
    if: needs.check-branch.outputs.skip != 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ‚¨áÔ∏è Checkout consumer repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # Necess√°rio para evitar falhas do gh CLI em reposit√≥rios grandes

      - name: üîê Authenticate GitHub CLI
        run: |
          # echo "${GITHUB_TOKEN}" | gh auth login --with-token
          gh auth setup-git
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: üè∑ Ensure auto-generated label exists
        run: |
          gh label create auto-generated --description "Pull Request criada automaticamente" --color 006B75 --force 
          gh label create "coverage-failed" --description "Cobertura de testes abaixo do limite m√≠nimo." --color "D93F0B" || true
          gh label create "coverage-passed" --description "Cobertura de testes acima do limite m√≠nimo." --color "0E8A16" || true
          gh label create "coverage-missing" --description "Cobertura de testes n√£o encontrada." --color "E99695" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: üìù Generate PR body
        run: |
          COVERAGE_LINE="${{ needs.run-coverage.outputs.line }}"
          COVERAGE_STATUS="${{ needs.run-coverage.outputs.status }}"
          MIN_COVERAGE="${{ inputs.min-coverage }}"
          MODE="${{ inputs.coverage-mode }}"

          if [ -n "$COVERAGE_LINE" ]; then
            COVERAGE_BLOCK=$(cat <<EOF
          ### üìä Cobertura de Testes

          | M√©trica | Valor |
          |--------|-------|
          | Linhas | **${COVERAGE_LINE}%** |
          | M√≠nimo exigido | ${MIN_COVERAGE}% |
          | Status | ${COVERAGE_STATUS} |
          | Modo | ${MODE} |

          EOF
          )
          else
            COVERAGE_BLOCK=$(cat <<EOF
          ### üìä Cobertura de Testes

          ‚ö†Ô∏è Cobertura n√£o gerada para este projeto.
          EOF
          )
          fi

          cat <<EOF > pr_body.md
          ## ü§ñ Pull Request Autom√°tica

          Esta PR foi criada ou atualizada automaticamente.

          **Origem:** \`${{ needs.check-branch.outputs.head }}\`  
          **Destino:** \`${{ needs.check-branch.outputs.base }}\`

          ---
          ‚úî CI executado com sucesso  
          ‚úî Testes validados  
          ‚úî Processo automatizado

          ${COVERAGE_BLOCK}

          ---
          _Gerado automaticamente pela action **auto-pr**_
          EOF

      - name: üìú Create or Update Pull Request
        run: |
          HEAD="${{ needs.check-branch.outputs.head }}"
          BASE="${{ needs.check-branch.outputs.base }}"
          TITLE="üîÄ PR ($(date +'%Y-%m-%d')):  ${HEAD} ‚Üí ${BASE}"
          STATUS_COVERAGE="${{ needs.run-coverage.outputs.status }}"

          if [ "$STATUS_COVERAGE" = "failed" ]; then
            ADD_LABEL="coverage-failed"
            DEL_LABEL="coverage-passed, coverage-missing"
          elif [ "$STATUS_COVERAGE" = "passed" ]; then
            ADD_LABEL="coverage-passed"
            DEL_LABEL="coverage-failed, coverage-missing"
          elif [ "$STATUS_COVERAGE" = "missing" ]; then
            ADD_LABEL="coverage-missing"
            DEL_LABEL="coverage-passed, coverage-failed"
          fi

          # Tenta encontrar um PR existente
          PR_NUMBER=$(gh pr list --base "$BASE" --head "$HEAD" --json number --jq '.[0].number')

          echo "$TITLE"

          if [ -z "$PR_NUMBER" ]; then
            echo "No existing PR found. Creating new PR..."
            gh pr create \
              --base "$BASE" \
              --head "$HEAD" \
              --title "$TITLE" \
              --body-file pr_body.md \
              --label "auto-generated, $ADD_LABEL" \
              --assignee "${{ github.actor }}"
          else
            echo "Existing PR #$PR_NUMBER found. Updating..."
            gh pr edit "$PR_NUMBER" \
              --title "$TITLE" \
              --body-file pr_body.md \
              --add-assignee "${{ github.actor }}" \
              --remove-label "$DEL_LABEL" \
              --add-label "$ADD_LABEL"            
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
