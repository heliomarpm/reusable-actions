name: Reusable Create/Update PR

on:
  workflow_call:
    inputs:
      skip-tests:
        type: boolean
        required: false
        default: false

      min-coverage:
        type: number
        required: false
        default: 80

      coverage-mode:
        type: string
        required: false
        default: "informative"    # informative | blocking | compare

      coverage-command:
        type: string
        required: false
        default: ""

      coverage-file:
        type: string
        required: false
        default: "coverage/coverage-summary.json"

    secrets:
      GH_TOKEN:
        required: true

jobs:
  check-branch:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check_files.outputs.skip-pr }}

    # permissions:
    #   contents: read
    #   pull-requests: write

    steps:
      - name: üìå Resolve PR base branch
        id: branch
        run: |
          HEAD="${{ github.event.workflow_run.head_branch }}"
          echo "Detected head branch: $HEAD"

          if [ "$HEAD" = "main" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          elif [ "$HEAD" = "develop" ]; then
            echo "base=main" >> $GITHUB_OUTPUT
          else
            echo "base=develop" >> $GITHUB_OUTPUT
          fi

          echo "head=$HEAD" >> $GITHUB_OUTPUT

      - name: üö´ Skip main branch
        if: steps.branch.outputs.skip == 'true'
        run: echo "Main branch detected. Skipping auto PR."

  coverage:
    needs: check-branch
    if: needs.check-branch.outputs.skip != 'true' && inputs.skip-tests != true 
    runs-on: ubuntu-latest

    steps:
      - name: üìä Generate coverage report
        if: inputs.skip-tests != true
        id: coverage
        run: |
          set -e

          mkdir -p coverage

          if [ -n "${{ inputs.coverage-command }}" ]; then
            echo "‚ñ∂ Running custom coverage command"
            eval "${{ inputs.coverage-command }}"
          else
            STACK=$(./scripts/detect-stack.sh)
            echo "Detected stack: $STACK"

            case "$STACK" in
              node) ./scripts/run-coverage-node.sh ;;
              dotnet) ./scripts/run-coverage-dotnet.sh ;;
              python) ./scripts/run-coverage-python.sh ;;
              *)
                echo "No coverage supported for this stack"
                exit 0
                ;;
            esac
          fi

          FILE="coverage/coverage-summary.normalized.json"
          LINE=$(jq '.line' "$FILE")

          echo "line=$LINE" >> $GITHUB_OUTPUT


      - name: ‚úÖ Evaluate coverage
        if: inputs.skip-tests != true
        id: coverage-check
        run: |
          LINE=${{ steps.coverage.outputs.line }}
          MIN=${{ inputs.min-coverage }}
          MODE="${{ inputs.coverage-mode }}"

          STATUS="passed"

          if (( $(echo "$LINE < $MIN" | bc -l) )); then
            STATUS="failed"
            if [ "$MODE" = "blocking" ]; then
              echo "Coverage below threshold"
              exit 1
            fi
          fi

          echo "status=$STATUS" >> $GITHUB_OUTPUT

  create-pr:
    needs: check-branch
    if: needs.check-branch.outputs.skip != 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ‚¨áÔ∏è Checkout consumer repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # Necess√°rio para evitar falhas do gh CLI em reposit√≥rios grandes

      - name: üîê Authenticate GitHub CLI
        run: |
          # echo "${GITHUB_TOKEN}" | gh auth login --with-token
          gh auth setup-git
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: üè∑ Ensure auto-generated label exists
        run: |
          gh label create auto-generated --description "Pull Request criada automaticamente" --color 006B75 --force 
          # gh label create "pending-review" --description "Aguardando revis√£o" --color "FBCA04" || true
          # gh label create "coverage-failed" --description "Cobertura de testes abaixo do limite m√≠nimo." --color "D93F0B" || true
          # gh label create "coverage-passed" --description "Cobertura de testes acima do limite m√≠nimo." --color "0E8A16" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: üìù Generate PR body
        run: |
          COVERAGE_LINE="${{ steps.coverage.outputs.line }}"
          COVERAGE_STATUS="${{ steps.coverage-check.outputs.status }}"
          MIN_COVERAGE="${{ inputs.min-coverage }}"
          MODE="${{ inputs.coverage-mode }}"

          if [ -n "$COVERAGE_LINE" ]; then
            COVERAGE_BLOCK=$(cat <<EOF
          ### üìä Cobertura de Testes

          | M√©trica | Valor |
          |--------|-------|
          | Linhas | **${COVERAGE_LINE}%** |
          | M√≠nimo exigido | ${MIN_COVERAGE}% |
          | Status | ${COVERAGE_STATUS} |
          | Modo | ${MODE} |

          EOF
          )
          else
            COVERAGE_BLOCK=$(cat <<EOF
          ### üìä Cobertura de Testes

          ‚ö†Ô∏è Cobertura n√£o gerada para este projeto.
          EOF
          )
          fi

          cat <<EOF > pr_body.md
          ## ü§ñ Pull Request Autom√°tica

          Esta PR foi criada ou atualizada automaticamente.

          **Origem:** \`${{ steps.branch.outputs.head }}\`  
          **Destino:** \`${{ steps.branch.outputs.base }}\`

          ---
          ‚úî CI executado com sucesso  
          ‚úî Testes validados  
          ‚úî Processo automatizado

          ${COVERAGE_BLOCK}

          ---
          _Gerado automaticamente pela action **auto-pr**_
          EOF

      - name: üìú Create or Update Pull Request
        run: |
          BASE="${{ steps.branch.outputs.base }}"
          HEAD="${{ steps.branch.outputs.head }}"
          TITLE="Auto PR: ${HEAD} ‚Üí ${BASE}"

          # Tenta encontrar um PR existente
          PR_NUMBER=$(gh pr list --base "$BASE" --head "$HEAD" --json number --jq '.[0].number')

          echo "üëâ $TITLE"

          if [ -z "$PR_NUMBER" ]; then
            echo "No existing PR found. Creating new PR..."
            gh pr create \
              --base "$BASE" \
              --head "$HEAD" \
              --title "$TITLE" \
              --body-file pr_body.md \
              --label auto-generated \
              --assignee "${{ github.actor }}"
          else
            echo "Existing PR #$PR_NUMBER found. Updating..."
            gh pr edit "$PR_NUMBER" \
              --title "$TITLE" \
              --body-file pr_body.md \
              --add-assignee "${{ github.actor }}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
