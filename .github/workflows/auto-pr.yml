name: Reusable Create/Update PR

on:
  workflow_call:
    inputs:
      min-coverage:
        description: 'Minimum coverage percentage (0-100 | default: 80)'
        type: number
        required: false
        default: 80

      coverage-mode:
        description: 'Coverage mode (info | block | decrease-only)'
        type: string
        required: false
        default: "info" 

      promotion_strategy:
        description: 'Promotion strategy (direct | release-branch)'
        required: false
        type: string
        default: direct
      semantic_release_config:
        description: 'Path to semantic-release config file. (only promotion_strategy=release-branch)'
        required: false
        type: string
      strict_conventional_commits:
        description: 'Fail pipeline if no conventional commits are found. (only promotion_strategy=release-branch)'
        required: false
        type: boolean
        default: true

    secrets:
      GH_TOKEN:
        required: true

jobs:
  resolve-branch:
    runs-on: ubuntu-latest
    outputs:
      head: ${{ steps.resolve.outputs.head }}
      base: ${{ steps.resolve.outputs.base }}
      skip: ${{ steps.resolve.outputs.skip }}

    steps:
      - name: üîç Resolve branches
        id: resolve
        run: |
          STRATEGY="${{ inputs.promotion_strategy }}"
          HEAD="${{ github.event.workflow_run.head_branch }}"

          echo "‚Üí Promotion strategy: $STRATEGY"
          echo "‚Üí Detected head branch: $HEAD"

          if [[ "$HEAD" == "main" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ "$STRATEGY" == "release-branch" && "$HEAD" == "develop" ]]; then
            BASE="__release__"
          elif [[ "$HEAD" == "develop" ]]; then
            BASE="main"
          else
            BASE="develop"
          fi

          echo "‚Üí Base branch: $BASE"

          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "head=$HEAD" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: üö´ Skip - main branch detected
        if: steps.resolve.outputs.skip == 'true'
        run: echo "‚Üí Main branch detected. Skipping auto PR."

  get-coverage:
    needs: resolve-branch
    if: needs.resolve-branch.outputs.skip != 'true'
    runs-on: ubuntu-latest
    outputs:
      line: ${{ steps.coverage.outputs.line }}
      status: ${{ steps.coverage-check.outputs.status }}

    steps:
      - name: üì• Download coverage artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-report
          path: coverage

      - name: üìä Read coverage report
        id: coverage
        run: |
          FILE="coverage/coverage-summary.normalized.json"

          if [ ! -f "$FILE" ]; then
            echo "‚ö†Ô∏è Coverage artifact not found"
            echo "line=" >> $GITHUB_OUTPUT
            echo "status=missing" >> $GITHUB_OUTPUT
            exit 0
          fi

          LINE=$(jq '.line' "$FILE")
          echo "line=$LINE" >> $GITHUB_OUTPUT
          echo "status=found" >> $GITHUB_OUTPUT

      - name: ‚úÖ Evaluate coverage
        id: coverage-check
        run: |
          FOUND_STATUS="${{ steps.coverage.outputs.status }}"
          LINE=${{ steps.coverage.outputs.line }}
          MIN=${{ inputs.min-coverage }}
          MODE="${{ inputs.coverage-mode }}"

          echo "‚Üí Minimum coverage: $MIN%"
          echo "‚Üí Coverage mode: $MODE"

          FINAL_STATUS="passed"

          if [ "$FOUND_STATUS" = "missing" ]; then
            FINAL_STATUS="missing"
            echo "‚ö†Ô∏è No tests or coverage detected"

            if [ "$MODE" = "block" ]; then
              echo "‚ùå Blocking PR: tests not implemented"
              exit 1
            fi
          elif  (( $(echo "$LINE < $MIN" | bc -l) )); then
            FINAL_STATUS="failed"
            echo "‚ùå Coverage below threshold ($LINE < $MIN)"

            if [ "$MODE" = "block" ]; then
              exit 1
            fi
          fi

          echo "status=$FINAL_STATUS" >> $GITHUB_OUTPUT

  create-pr:
    needs:
      - resolve-branch
      - get-coverage
    if: needs.resolve-branch.outputs.skip != 'true'
    runs-on: ubuntu-latest
    env:
      REUSABLE_PATH: __reusable_actions__

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ‚¨áÔ∏è Checkout consumer repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necess√°rio para evitar falhas do gh CLI em reposit√≥rios grandes

      - name: üîê Auth GitHub CLI
        run: |
          # echo "${GITHUB_TOKEN}" | gh auth login --with-token
          gh auth setup-git
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}


      - name: üå± Create release branch
        id: release-branch
        if: needs.resolve-branch.outputs.base == '__release__' # && inputs.promotion_strategy == 'release-branch'
        run: |
          VERSION=$(bash "$REUSABLE_PATH/scripts/shared/semantic-release/next-version.sh")

          if [[ -z "$VERSION" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          BRANCH="release-$VERSION"
          git checkout -b "$BRANCH"
          git push origin "$BRANCH"

          echo "name=$BRANCH" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          REUSABLE_PATH: ${{ env.REUSABLE_PATH }}
          SEMANTIC_RELEASE_CONFIG: ${{ inputs.semantic_release_config }}
          STRICT_CONVENTIONAL_COMMITS: ${{ inputs.strict_conventional_commits }}


      - name: üìå Resolve final branches
        id: final-branches
        run: |
          if [[ "${{ needs.resolve-branch.outputs.base }}" == "__release__" ]]; then
            BASE="${{ steps.release-branch.outputs.name }}"          
          else
            BASE="${{ needs.resolve-branch.outputs.base }}"
          fi
          
          HEAD="${{ needs.resolve-branch.outputs.head }}"
          
          echo "‚Üí Final branches: $BASE -> $HEAD"
          
          echo "base=$BASE" >> $GITHUB_OUTPUT
          echo "head=$HEAD" >> $GITHUB_OUTPUT

      - name: üè∑ Ensure auto-generated label exists
        run: |
          gh label create auto-generated --description "Pull Request criada automaticamente" --color 006B75 || true
          gh label create "coverage-failed" --description "Cobertura de testes abaixo do limite m√≠nimo." --color "D93F0B" || true
          gh label create "coverage-passed" --description "Cobertura de testes acima do limite m√≠nimo." --color "0E8A16" || true
          gh label create "coverage-missing" --description "Cobertura de testes n√£o encontrada." --color "E99695" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}


      - name: üìù Generate PR body
        run: |
          COVERAGE_LINE="${{ needs.get-coverage.outputs.line }}"
          COVERAGE_STATUS="${{ needs.get-coverage.outputs.status }}"
          MIN_COVERAGE="${{ inputs.min-coverage }}"
          MODE="${{ inputs.coverage-mode }}"

          if [ -n "$COVERAGE_LINE" ]; then
            COVERAGE_BLOCK=$(cat <<EOF
          ### üìä Cobertura de Testes

          ```cmd
          | M√©trica | Valor |
          |--------|-------|
          | Linhas | **${COVERAGE_LINE}%** |
          | M√≠nimo exigido | ${MIN_COVERAGE}% |
          | Status | ${COVERAGE_STATUS} |
          | Modo | ${MODE} |
          ```

          EOF
          )
          else
            COVERAGE_BLOCK=$(cat <<EOF
          ### üìä Cobertura de Testes

          ‚ö†Ô∏è Cobertura n√£o gerada para este projeto.
          EOF
          )
          fi

          cat <<EOF > pr_body.md
          ## ü§ñ Pull Request Autom√°tica

          Esta PR foi criada ou atualizada automaticamente.

          **Origem:** \`${{ steps.final-branches.outputs.head }}\`  
          **Destino:** \`${{ steps.final-branches.outputs.base }}\`

          ---
          ‚úî CI executado com sucesso  
          ‚úî Testes validados  
          ‚úî Processo automatizado

          ${COVERAGE_BLOCK}          

          ---
          _Gerado automaticamente pela action **auto-pr**_
          EOF

      - name: üìú Create or Update Pull Request
        id: create-pr
        run: |
          HEAD="${{ steps.final-branches.outputs.head }}"
          BASE="${{ steps.final-branches.outputs.base }}"
          TITLE="üîÄ PR ($(date +'%Y-%m-%d')):  ${HEAD} ‚Üí ${BASE}"
          STATUS_COVERAGE="${{ needs.get-coverage.outputs.status }}"

          if [ "$STATUS_COVERAGE" = "failed" ]; then
            ADD_LABEL="coverage-failed"
            DEL_LABEL="coverage-passed,coverage-missing"
          elif [ "$STATUS_COVERAGE" = "passed" ]; then
            ADD_LABEL="coverage-passed"
            DEL_LABEL="coverage-failed,coverage-missing"
          elif [ "$STATUS_COVERAGE" = "missing" ]; then
            ADD_LABEL="coverage-missing"
            DEL_LABEL="coverage-passed,coverage-failed"
          fi

          # Tenta encontrar um PR existente
          PR_NUMBER=$(gh pr list --base "$BASE" --head "$HEAD" --json number --jq '.[0].number')

          echo "$TITLE"

          if [ -z "$PR_NUMBER" ]; then
            echo "‚Üí No existing PR found. Creating new PR..."
            gh pr create \
              --base "$BASE" \
              --head "$HEAD" \
              --title "$TITLE" \
              --body-file pr_body.md \
              --label "auto-generated,$ADD_LABEL" \
              --assignee "${{ github.actor }}"

            # Fetch PR URL after creation
            PR_URL=$(gh pr view "$HEAD" --json url --jq '.url')
            PR_ACTION="created"
          else
            echo "‚Üí Existing PR #$PR_NUMBER found. Updating..."
            gh pr edit "$PR_NUMBER" \
              --title "$TITLE" \
              --body-file pr_body.md \
              --add-assignee "${{ github.actor }}" \
              --remove-label "$DEL_LABEL" \
              --add-label "$ADD_LABEL"

            PR_URL="https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
            PR_ACTION="updated"
          fi

          echo "::notice title=Auto PR ${PR_ACTION}::${HEAD} ‚Üí ${BASE}"
          echo "::notice title=Pull Request::${PR_URL}"

          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "pr_action=${PR_ACTION}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: üßæ Job summary
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## üîÄ Auto Pull Request

          **Status:** ${{ steps.create-pr.outputs.pr_action || 'processed' }}

          **From:** \`${{ steps.final-branches.outputs.head }}\`  
          **To:** \`${{ steps.final-branches.outputs.base }}\`

          **Coverage:** ${{ needs.get-coverage.outputs.status }}

          üîó **PR:** ${{ steps.create-pr.outputs.pr_url }}

          ---
          _Gerado automaticamente pela action **auto-pr**_
          EOF
