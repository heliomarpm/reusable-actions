name: Reusable Semantic Release

on:
  workflow_call:
    inputs:
      project_path:
        required: false
        type: string
        default: "."
      stack:
        description: 'Stack the project. (node | php | dotnet | python | go | empty for auto-detect)'
        required: false
        type: string
        default: null
      semantic_release_config:
        description: 'Path to semantic-release config file.'
        required: false
        type: string
      semantic_release_dry_run:
        description: 'Dry run mode for semantic-release. (default: false -> true for PRs)'
        required: false
        type: boolean
        default: false
      semantic_release_debug_mode:
        description: 'Debug mode for semantic-release.'
        required: false
        type: boolean
        default: false
      strict_conventional_commits:
        description: 'Fail pipeline if no conventional commits are found'
        required: false
        type: boolean
        default: true
      release_strategy:
        description: 'Release flow strategy (direct | release-branch)'
        required: false
        type: string
        default: direct

    secrets:
      GH_TOKEN:
        required: true

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    env:
      REUSABLE_PATH: __reusable_actions__

    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.project_path }}

    permissions:
      actions: read
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with: 
          # A linha 'ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0 	  # Necess√°rio para o semantic-release inspecionar hist√≥rico
          fetch-tags: true 	# Necess√°rio para o semantic-release inspecionar tags
          persist-credentials: true  # ‚Üí permite push com GITHUB_TOKEN
          token: ${{ secrets.GH_TOKEN }} # Necess√°rio para autenticar PUSH

      - name: Checkout reusable-actions scripts
        uses: actions/checkout@v4
        with:
          repository: heliomarpm/reusable-actions
          ref: main
          path: ${{ env.REUSABLE_PATH }}
          token: ${{ secrets.GH_TOKEN }} # Necess√°rio se o reposit√≥rio for privado


      - name: Files in workspace
        run: |
          echo "üìÇ Current directory:"
          pwd
          echo "üìÑ Files in root:"
          ls -la


      - name: ‚öôÔ∏è Configurar Usu√°rio Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"


      - name: üîç Resolve project stack
        id: stack
        working-directory: ${{ inputs.project_path }}
        run: |
          if [[ -n "${{ inputs.stack }}" ]]; then
            echo "‚Üí Using stack from input: ${{ inputs.stack }}"
            echo "value=${{ inputs.stack }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          chmod +x $REUSABLE_PATH/scripts/shared/detect-stack.sh
          STACK=$($REUSABLE_PATH/scripts/shared/detect-stack.sh)

          if [[ -z "$STACK" ]]; then
            echo "value=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ Detected stack: $STACK"
          echo "value=$STACK" >> $GITHUB_OUTPUT

          
      - name: Fail if stack not detected
        if: steps.stack.outputs.value == ''
        run: |
          echo "‚ùå Stack not detected. Check project_path or repository structure."
          exit 1          


      - name: üöÄ Run Release
        if: steps.stack.outputs.value != ''
        run: |
          SCRIPT="$REUSABLE_PATH/scripts/shared/semantic-release.sh"
          chmod +x "$SCRIPT"
          "$SCRIPT"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          STACK: ${{ steps.stack.outputs.value }}
          REUSABLE_PATH: ${{ env.REUSABLE_PATH }}
          SEMANTIC_RELEASE_CONFIG: ${{ inputs.semantic_release_config }}
          SEMANTIC_RELEASE_DRY_RUN: ${{ inputs.semantic_release_dry_run }}
          SEMANTIC_RELEASE_DEBUG_MODE: ${{ inputs.semantic_release_debug_mode }}
          STRICT_CONVENTIONAL_COMMITS: ${{ inputs.strict_conventional_commits }}
          RELEASE_STRATEGY: ${{ inputs.release_strategy }}

