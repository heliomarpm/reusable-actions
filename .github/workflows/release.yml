name: Reusable Release

on:
  workflow_call:
    inputs:
      project_path:
        required: false
        type: string
        default: "."
      stack:
        required: false
        type: string
        default: ""     # node | php | dotnet | python | go | empty for auto-detect

    secrets:
      GH_TOKEN:
        required: true

jobs:
  env:
    REUSABLE_PATH: .__reusable_actions__

  resolve-stack:
    runs-on: ubuntu-latest
    outputs:
      stack: ${{ steps.stack.outputs.value }}

    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4

      - name: Checkout reusable-actions scripts
        uses: actions/checkout@v4
        with:
          repository: heliomarpm/reusable-actions
          ref: main
          path: ${{ env.REUSABLE_PATH }}


      - name: Files in workspace
        run: |
          echo "ðŸ“‚ Current directory:"
          pwd
          echo "ðŸ“„ Files in root:"
          ls -la


      - name: Resolve project stack
        id: stack
        working-directory: ${{ inputs.project_path }}
        run: |
          if [[ -n "${{ inputs.stack }}" ]]; then
            echo "Using stack from input: ${{ inputs.stack }}"
            echo "value=${{ inputs.stack }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          chmod +x $REUSABLE_PATH/scripts/detect-stack.sh
          STACK=$($REUSABLE_PATH/scripts/detect-stack.sh)

          if [[ -z "$STACK" ]]; then
            echo "value=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… Detected stack: $STACK"
          echo "value=$STACK" >> $GITHUB_OUTPUT

  release:
    runs-on: ubuntu-latest
    needs: resolve-stack
    permissions:
      contents: write
      actions: write
      issues: write  

    steps:
      - name: ðŸš€ Run release
        # working-directory: ${{ inputs.project_path }}
        run: |
          chmod +x $REUSABLE_PATH/scripts/release/${{ needs.resolve-stack.outputs.stack }}/release.sh
          $REUSABLE_PATH/scripts/release/${{ needs.resolve-stack.outputs.stack }}/release.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
